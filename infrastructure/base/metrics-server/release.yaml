apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: metrics-default
spec:
  releaseName: metrics-default
  chart:
    spec:
      chart: metrics-server
      sourceRef:
        kind: HelmRepository
        name: metrics-server
        namespace: flux-system
      version: 3.8.3
  interval: 1h0m0s
  install:
    remediation:
      retries: 3
  values:
    args:
      - --kubelet-preferred-address-types=InternalIP
      - --authentication-token-webhook=true
      - --requestheader-allowed-names=aggregated-metrics-server
      - --requestheader-client-ca-file=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      - --requestheader-extra-headers-prefix=X-Remote-Extra-
      - --requestheader-group-headers=X-Remote-Group
      - --requestheader-username-headers=X-Remote-User
      - --tls-cert-file=/var/run/secrets/kubernetes.io/serviceaccount/tls.crt
      - --tls-private-key-file=/var/run/secrets/kubernetes.io/serviceaccount/tls.key
    rbac:
      create: true
    serviceAccount:
      create: true